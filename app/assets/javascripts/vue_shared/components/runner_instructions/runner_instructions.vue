<script>
import {
  GlAlert,
  GlButton,
  GlModal,
  GlModalDirective,
  GlButtonGroup,
  GlDropdown,
  GlDropdownItem,
  GlIcon,
  GlLoadingIcon,
} from '@gitlab/ui';
import { isEmpty } from 'lodash';
import { __, s__ } from '~/locale';
import ModalCopyButton from '~/vue_shared/components/modal_copy_button.vue';
import {
  PLATFORMS_WITHOUT_ARCHITECTURES,
  INSTRUCTIONS_PLATFORMS_WITHOUT_ARCHITECTURES,
} from './constants';
import getRunnerPlatforms from './graphql/queries/get_runner_platforms.query.graphql';
import getRunnerSetupInstructions from './graphql/queries/get_runner_setup.query.graphql';

export default {
  components: {
    GlAlert,
    GlButton,
    GlButtonGroup,
    GlDropdown,
    GlDropdownItem,
    GlModal,
    GlIcon,
    GlLoadingIcon,
    ModalCopyButton,
  },
  directives: {
    GlModalDirective,
  },
  apollo: {
    platforms: {
      query: getRunnerPlatforms,
      update(data) {
        return data?.runnerPlatforms?.nodes.map(({ name, humanReadableName, architectures }) => {
          return {
            name,
            humanReadableName,
            architectures: architectures?.nodes || [],
          };
        });
      },
      result() {
        // Select first platform by default
        this.selectPlatform(this.platforms[0]);
      },
      error() {
        this.toggleAlert(true);
      },
    },
    instructions: {
      query: getRunnerSetupInstructions,
      skip() {
        return !this.selectedPlatform;
      },
      variables() {
        return {
          platform: this.selectedPlatform.name,
          architecture: this.selectedArchitecture?.name || '',
        };
      },
      update(data) {
        return data?.runnerSetup;
      },
      error() {
        this.toggleAlert(true);
      },
    },
  },
  data() {
    return {
      platforms: [],
      selectedPlatform: null,
      selectedArchitecture: null,
      showAlert: false,
      instructions: {},
    };
  },
  computed: {
    instructionsEmpty() {
      return isEmpty(this.instructions);
    },
    selectedPlatformName() {
      return this.selectedPlatform?.name;
    },
    selectedArchitectureName() {
      return this.selectedArchitecture?.name;
    },
    hasArchitecureList() {
      return !PLATFORMS_WITHOUT_ARCHITECTURES.includes(this.selectedPlatformName);
    },
    instructionsWithoutArchitecture() {
      return INSTRUCTIONS_PLATFORMS_WITHOUT_ARCHITECTURES[this.selectedPlatformName]?.instructions;
    },
    runnerInstallationLink() {
      return INSTRUCTIONS_PLATFORMS_WITHOUT_ARCHITECTURES[this.selectedPlatformName]?.link;
    },
  },
  methods: {
    selectPlatform(platform) {
      this.selectedPlatform = platform;

      if (!platform.architectures?.some(({ name }) => name === this.selectedArchitectureName)) {
        // Select first architecture when current value is not available
        this.selectArchitecture(platform.architectures[0]);
      }
    },
    selectArchitecture(architecture) {
      this.selectedArchitecture = architecture;
    },
    toggleAlert(state) {
      this.showAlert = state;
    },
  },
  modalId: 'installation-instructions-modal',
  i18n: {
    installARunner: s__('Runners|Install a Runner'),
    architecture: s__('Runners|Architecture'),
    downloadInstallBinary: s__('Runners|Download and Install Binary'),
    downloadLatestBinary: s__('Runners|Download Latest Binary'),
    registerRunnerCommand: s__('Runners|Register Runner Command'),
    fetchError: s__('Runners|An error has occurred fetching instructions'),
    instructions: s__('Runners|Show Runner installation instructions'),
    copyInstructions: s__('Runners|Copy instructions'),
  },
  closeButton: {
    text: __('Close'),
    attributes: [{ variant: 'default' }],
  },
};
</script>
<template>
  <div>
    <gl-button
      v-gl-modal-directive="$options.modalId"
      class="gl-mt-4"
      data-testid="show-modal-button"
    >
      {{ $options.i18n.instructions }}
    </gl-button>
    <gl-modal
      :modal-id="$options.modalId"
      :title="$options.i18n.installARunner"
      :action-secondary="$options.closeButton"
    >
      <gl-alert v-if="showAlert" variant="danger" @dismiss="toggleAlert(false)">
        {{ $options.i18n.fetchError }}
      </gl-alert>
      <h5>
        {{ __('Environment') }}
      </h5>
      <gl-button-group class="gl-mb-3">
        <gl-button
          v-for="platform in platforms"
          :key="platform.name"
          :selected="selectedPlatform && selectedPlatform.name === platform.name"
          data-testid="platform-button"
          @click="selectPlatform(platform)"
        >
          {{ platform.humanReadableName }}
        </gl-button>
      </gl-button-group>
      <template v-if="hasArchitecureList">
        <template v-if="selectedPlatform">
          <h5>
            {{ $options.i18n.architecture }}
            <gl-loading-icon v-if="$apollo.loading" inline />
          </h5>

          <gl-dropdown class="gl-mb-3" :text="selectedArchitectureName">
            <gl-dropdown-item
              v-for="architecture in selectedPlatform.architectures"
              :key="architecture.name"
              :is-check-item="true"
              :is-checked="selectedArchitectureName === architecture.name"
              data-testid="architecture-dropdown-item"
              @click="selectArchitecture(architecture)"
            >
              {{ architecture.name }}
            </gl-dropdown-item>
          </gl-dropdown>
          <div class="gl-display-flex gl-align-items-center gl-mb-3">
            <h5>{{ $options.i18n.downloadInstallBinary }}</h5>
            <gl-button
              class="gl-ml-auto"
              :href="selectedArchitecture.downloadLocation"
              download
              icon="download"
              data-testid="binary-download-button"
            >
              {{ $options.i18n.downloadLatestBinary }}
            </gl-button>
          </div>
        </template>
        <template v-if="!instructionsEmpty">
          <div class="gl-display-flex">
            <pre
              class="gl-bg-gray gl-flex-fill-1 gl-white-space-pre-line"
              data-testid="binary-instructions"
              >{{ instructions.installInstructions }}</pre
            >
            <modal-copy-button
              :title="$options.i18n.copyInstructions"
              :text="instructions.installInstructions"
              :modal-id="$options.modalId"
              css-classes="gl-align-self-start gl-ml-2 gl-mt-2"
              category="tertiary"
            />
          </div>

          <h5 class="gl-mb-3">{{ $options.i18n.registerRunnerCommand }}</h5>
          <div class="gl-display-flex">
            <pre
              class="gl-bg-gray gl-flex-fill-1 gl-white-space-pre-line"
              data-testid="runner-instructions"
              >{{ instructions.registerInstructions }}</pre
            >
            <modal-copy-button
              :title="$options.i18n.copyInstructions"
              :text="instructions.registerInstructions"
              :modal-id="$options.modalId"
              css-classes="gl-align-self-start gl-ml-2 gl-mt-2"
              category="tertiary"
            />
          </div>
        </template>
      </template>
      <template v-else>
        <div>
          <p>{{ instructionsWithoutArchitecture }}</p>
          <gl-button :href="runnerInstallationLink">
            <gl-icon name="external-link" />
            {{ s__('Runners|View installation instructions') }}
          </gl-button>
        </div>
      </template>
    </gl-modal>
  </div>
</template>
