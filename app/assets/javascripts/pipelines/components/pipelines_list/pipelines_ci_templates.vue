<script>
import { GlButton, GlLoadingIcon, GlAlert, GlCard, GlEmoji } from '@gitlab/ui';
import Api from '~/api';
import { mergeUrlParams } from '~/lib/utils/url_utility';
import { s__, sprintf } from '~/locale';
import {
  SUGGESTED_CI_TEMPLATES,
  API_CI_TEMPLATE_TYPE,
  HELLO_WORLD_TEMPLATE_KEY,
} from '../../constants';

export default {
  components: {
    GlButton,
    GlLoadingIcon,
    GlAlert,
    GlCard,
    GlEmoji,
  },
  i18n: {
    errorMessage: s__('Pipelines|An error occurred. Please try again.'),
    test: {
      title: s__('Pipelines|Try a test template'),
      subtitle: s__(
        'Pipelines|Use a test template including a set up program and a basic gitlab-ci.yml file to explore how CI/CD works.',
      ),
      cta: s__('Pipelines|Try test template'),
      helloWorld: {
        title: s__('Pipelines|“Hello world” with GitLab CI'),
        description: s__(
          'Pipelines|Get familiar with GitLab CI syntax by  setting up a simple pipeline running a  “Hello world” script. ',
        ),
      },
    },
    templates: {
      title: s__('Pipelines|Try a sample CI/CD file'),
      subtitle: s__(
        'Pipelines|Use a sample file to implement GitLab CI/CD based on your project’s language/framework.',
      ),
      cta: s__('Pipelines|Use template'),
      description: s__(
        'Pipelines|Continuous deployment template to test and deploy your %{name} project.',
      ),
    },
  },
  inject: ['projectId', 'addCiYmlPath'],
  data() {
    const helloWorldTemplateUrl = mergeUrlParams(
      { template: HELLO_WORLD_TEMPLATE_KEY },
      this.addCiYmlPath,
    );

    return {
      isLoading: false,
      hasError: false,
      templates: [],
      helloWorldTemplateUrl,
    };
  },
  mounted() {
    this.fetchTemplates();
  },
  methods: {
    fetchTemplates() {
      this.isLoading = true;

      Api.projectTemplates(this.projectId, API_CI_TEMPLATE_TYPE, { per_page: 100 })
        .then(({ data }) => this.setCiTemplates(data))
        .catch(() => {
          this.hasError = true;
        })
        .finally(() => {
          this.isLoading = false;
        });
    },
    setCiTemplates(allTemplates) {
      this.templates = allTemplates
        .filter((template) => SUGGESTED_CI_TEMPLATES[template.key])
        .map(({ name, key }) => {
          return {
            name,
            logoPath: SUGGESTED_CI_TEMPLATES[key].logoPath,
            link: mergeUrlParams({ template: key }, this.addCiYmlPath),
            description: sprintf(this.$options.i18n.templates.description, { name }),
          };
        });
    },
  },
};
</script>
<template>
  <div>
    <div v-if="isLoading" class="gl-mt-3">
      <gl-loading-icon data-testid="loading-icon" />
    </div>

    <gl-alert v-if="hasError" variant="danger" :dismissible="false" class="gl-mt-3">
      {{ $options.i18n.errorMessage }}
    </gl-alert>
    <div v-else>
      <h2 class="gl-font-size-h2">{{ $options.i18n.test.title }}</h2>
      <p class="gl-text-gray-800 gl-mb-6">{{ $options.i18n.test.subtitle }}</p>

      <div class="row gl-mb-8">
        <div class="col-lg-3">
          <gl-card>
            <div class="gl-flex-direction-row">
              <div class="gl-py-5"><gl-emoji class="gl-font-size-h2-xl" data-name="wave" /></div>
              <div class="gl-mb-3">
                <strong class="gl-text-gray-800 gl-mb-2">{{
                  $options.i18n.test.helloWorld.title
                }}</strong>
              </div>
              <p class="gl-font-sm">{{ $options.i18n.test.helloWorld.description }}</p>
            </div>

            <gl-button
              category="primary"
              variant="confirm"
              :href="helloWorldTemplateUrl"
              data-testid="test-template-link"
              >{{ $options.i18n.test.cta }}</gl-button
            >
          </gl-card>
        </div>
      </div>

      <h2 class="gl-font-size-h2">{{ $options.i18n.templates.title }}</h2>
      <p class="gl-text-gray-800 gl-mb-6">{{ $options.i18n.templates.subtitle }}</p>

      <ul class="gl-list-style-none gl-pl-0">
        <li v-for="template in templates" :key="template.key">
          <div
            class="gl-display-flex gl-align-items-center gl-justify-content-space-between gl-border-b-solid gl-border-b-1 gl-border-b-gray-100 gl-pb-5 gl-pt-5"
          >
            <div class="gl-display-flex gl-flex-direction-row gl-align-items-center">
              <img
                width="64"
                height="64"
                :src="template.logoPath"
                class="gl-mr-6"
                data-testid="template-logo"
              />
              <div class="gl-flex-direction-row">
                <div class="gl-mb-3">
                  <strong class="gl-text-gray-800" datatestid="template-name">{{
                    template.name
                  }}</strong>
                </div>
                <p class="gl-mb-0 gl-font-sm" data-testid="template-description">
                  {{ template.description }}
                </p>
              </div>
            </div>
            <gl-button
              category="primary"
              variant="confirm"
              :href="template.link"
              data-testid="template-link"
              >{{ $options.i18n.templates.cta }}</gl-button
            >
          </div>
        </li>
      </ul>
    </div>
  </div>
</template>
