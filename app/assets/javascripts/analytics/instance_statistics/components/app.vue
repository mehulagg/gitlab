<script>
import { s__ } from '~/locale';
import InstanceCounts from './instance_counts.vue';
import InstanceStatisticsCountChart from './instance_statistics_count_chart.vue';
import UsersChart from './users_chart.vue';
import query from '../graphql/queries/instance_count.query.graphql';
import { TODAY, TOTAL_DAYS_TO_SHOW, START_DATE } from '../constants';

const PIPELIES_KEY_TO_NAME_MAP = {
  total: s__('InstanceAnalytics|Total'),
  succeeded: s__('InstanceAnalytics|Succeeded'),
  failed: s__('InstanceAnalytics|Failed'),
  canceled: s__('InstanceAnalytics|Canceled'),
  skipped: s__('InstanceAnalytics|Skipped'),
};
const ISSUES_AND_MERGE_REQUESTS_KEY_TO_NAME_MAP = {
  issues: s__('InstanceAnalytics|Issues'),
  mergeRequests: s__('InstanceAnalytics|Merge Requests'),
};
const loadPipelineChartError = s__(
  'InstanceAnalytics|Could not load the pipelines chart. Please refresh the page to try again.',
);
const loadIssuesAndMergeRequestsChartError = s__(
  'InstanceAnalytics|Could not load the issues and merge requests chart. Please refresh the page to try again.',
);
const noDataMessage = s__('InstanceAnalytics|There is no data available.');

export default {
  name: 'InstanceStatisticsApp',
  components: {
    InstanceCounts,
    InstanceStatisticsCountChart,
    UsersChart,
  },
  TOTAL_DAYS_TO_SHOW,
  START_DATE,
  TODAY,
  configs: [
    {
      keyToNameMap: {
        projects: s__('InstanceAnalytics|Projects'),
        groups: s__('InstanceAnalytics|Groups'),
      },
      prefix: 'projectsAndGroups',
      loadChartError: s__(
        'InstanceAnalytics|Could not load the projects and groups chart. Please refresh the page to try again.',
      ),
      noDataMessage,
      chartTitle: s__('InstanceAnalytics|Total projects & groups'),
      yAxisTitle: s__('InstanceAnalytics|Items'),
      xAxisTitle: s__('InstanceAnalytics|Month'),
      queries: [
        {
          query,
          name: 'projects',
          title: 'Projects',
          identifier: 'PROJECTS',
        },
        {
          query,
          name: 'groups',
          title: 'Groups',
          identifier: 'GROUPS',
        },
      ],
    },
    {
      keyToNameMap: PIPELIES_KEY_TO_NAME_MAP,
      prefix: 'pipelines',
      loadChartError: loadPipelineChartError,
      noDataMessage,
      chartTitle: s__('InstanceAnalytics|Pipelines'),
      yAxisTitle: s__('InstanceAnalytics|Items'),
      xAxisTitle: s__('InstanceAnalytics|Month'),
      queries: [
        {
          query,
          name: 'pipelinesTotal',
          title: 'Pipelines total',
          identifier: 'PIPELINES',
        },
        {
          query,
          name: 'pipelinesSucceeded',
          title: 'Pipelines succeeded',
          identifier: 'PIPELINES_SUCCEEDED',
        },
        {
          query,
          name: 'pipelinesFailed',
          title: 'Pipelines failed',
          identifier: 'PIPELINES_FAILED',
        },
        {
          query,
          name: 'pipelinesCanceled',
          title: 'Pipelines canceled',
          identifier: 'PIPELINES_CANCELED',
        },
        {
          query,
          name: 'pipelinesSkipped',
          title: 'Pipelines skipped',
          identifier: 'PIPELINES_SKIPPED',
        },
      ],
    },
    {
      keyToNameMap: ISSUES_AND_MERGE_REQUESTS_KEY_TO_NAME_MAP,
      prefix: 'issuesAndMergeRequests',
      loadChartError: loadIssuesAndMergeRequestsChartError,
      noDataMessage,
      chartTitle: s__('InstanceAnalytics|Issues & Merge Requests'),
      yAxisTitle: s__('InstanceAnalytics|Items'),
      xAxisTitle: s__('InstanceAnalytics|Month'),
      queries: [
        {
          query,
          name: 'issues',
          title: 'Issues',
          identifier: 'ISSUES',
        },
        {
          query,
          name: 'mergeRequests',
          title: 'Merge requests',
          identifier: 'MERGE_REQUESTS',
        },
      ],
    },
  ],
};
</script>

<template>
  <div>
    <instance-counts />
    <users-chart
      :start-date="$options.START_DATE"
      :end-date="$options.TODAY"
      :total-data-points="$options.TOTAL_DAYS_TO_SHOW"
    />
    <instance-statistics-count-chart
      v-for="chartOptions in $options.configs"
      :key="chartOptions.chartTitle"
      :prefix="chartOptions.prefix"
      :key-to-name-map="chartOptions.keyToNameMap"
      :queries="chartOptions.queries"
      :x-axis-title="chartOptions.xAxisTitle"
      :y-axis-title="chartOptions.yAxisTitle"
      :load-chart-error-message="chartOptions.loadChartError"
      :no-data-message="chartOptions.noDataMessage"
      :chart-title="chartOptions.chartTitle"
    />
  </div>
</template>
