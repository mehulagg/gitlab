import { shallowMount } from '@vue/test-utils';
import { GlLink } from '@gitlab/ui';
import { n__ } from '~/locale';
import { trimText } from 'helpers/text_helper';
import { severityGroupTypes } from 'ee/security_dashboard/store/modules/vulnerable_projects/constants';
import { Accordion, AccordionItem } from 'ee/vue_shared/components/accordion';
import VulnerabilitySeverity from 'ee/security_dashboard/components/first_class_vulnerability_severities.vue';

describe('Vulnerability Severity component', () => {
  let wrapper;

  const helpPagePath = 'http://localhost/help-me';
  const projects = [
    {
      id: 'gid://gitlab/Project/11',
      name: 'Security Reports Internal',
      nameWithNamespace: 'Administrator / Security Reports Internal',
      fullPath: 'root/security-reports-internal',
      vulnerabilitySeveritiesCount: {
        critical: 2,
        high: 1,
        info: 0,
        low: 2,
        medium: 5,
        unknown: 3,
      },
    },
    {
      id: 'gid://gitlab/Project/1',
      name: 'Gitlab Test',
      nameWithNamespace: 'Gitlab Org / Gitlab Test',
      fullPath: 'gitlab-org/gitlab-test',
      vulnerabilitySeveritiesCount: {
        critical: 0,
        high: 0,
        info: 1,
        low: 0,
        medium: 4,
        unknown: 0,
      },
    },
    {
      id: 'gid://gitlab/Project/2',
      name: 'Gitlab Test',
      nameWithNamespace: 'Gitlab Org / Gitlab Test - 2',
      fullPath: 'gitlab-org/gitlab-test',
      vulnerabilitySeveritiesCount: {},
    },
    {
      id: 'gid://gitlab/Project/3',
      name: 'Gitlab Test',
      nameWithNamespace: 'Gitlab Org / Gitlab Test - 3',
      fullPath: 'gitlab-org/gitlab-test',
      vulnerabilitySeveritiesCount: {
        critical: 0,
      },
    },
  ];

  const createWrapper = ({ propsData }) => {
    return shallowMount(VulnerabilitySeverity, {
      propsData: {
        helpPagePath,
        ...propsData,
      },
      stubs: {
        Accordion,
        AccordionItem,
      },
    });
  };

  const findHelpLink = () => wrapper.find(GlLink);
  const findHeader = () => wrapper.find('h4');
  const findDescription = () => wrapper.find('p');
  const findAccordionItemByGrade = grade => wrapper.find({ ref: `accordionItem${grade}` });
  const findProjectName = accordion => accordion.findAll(GlLink);

  afterEach(() => {
    wrapper.destroy();
    wrapper = null;
  });

  beforeEach(() => {
    wrapper = createWrapper({ propsData: { projects } });
  });

  describe('for all cases', () => {
    it('has the link to the help page', () => {
      expect(findHelpLink().attributes('href')).toBe(helpPagePath);
    });

    it('has a correct header', () => {
      expect(findHeader().text()).toBe('Project security status');
    });

    it('has a correct description', () => {
      expect(findDescription().text()).toBe(
        'Projects are graded based on the highest severity vulnerability present',
      );
    });
  });

  describe.each`
    grade                   | relatedProjects               | correspondingMostSevereVulnerability                            | levels
    ${severityGroupTypes.F} | ${[projects[0]]}              | ${['2 Critical']}                                               | ${'Critical'}
    ${severityGroupTypes.D} | ${[projects[0]]}              | ${['1 High']}                                                   | ${'High or unknown'}
    ${severityGroupTypes.C} | ${[projects[0], projects[1]]} | ${['5 Medium', '4 Medium']}                                     | ${'Medium'}
    ${severityGroupTypes.B} | ${[projects[0]]}              | ${['2 Low']}                                                    | ${'Low'}
    ${severityGroupTypes.A} | ${[projects[2], projects[3]]} | ${['No vulnerabilities present', 'No vulnerabilities present']} | ${'No'}
  `(
    'for grade $grade',
    ({ grade, relatedProjects, correspondingMostSevereVulnerability, levels }) => {
      let accordion;
      let text;

      beforeEach(() => {
        accordion = findAccordionItemByGrade(grade);
        text = trimText(accordion.text());
      });

      it('has a corresponding accordion item', () => {
        expect(accordion.exists()).toBe(true);
      });

      it('has the projects listed in the accordion item', () => {
        relatedProjects.forEach((project, i) => {
          const projectLink = findProjectName(accordion).at(i);
          expect(projectLink.text()).toBe(project.nameWithNamespace);
          expect(projectLink.attributes('href')).toBe(`/${project.fullPath}/-/security/dashboard`);
        });
      });

      it('states how many projects are there in the group', () => {
        expect(text).toContain(n__('%d project', '%d projects', relatedProjects.length));
      });

      it('states which levels belong to the group', () => {
        expect(text).toContain(`${levels} vulnerabilities present`);
      });

      it('states the most severe vulnerability', () => {
        relatedProjects.forEach((_, i) => {
          expect(text).toContain(correspondingMostSevereVulnerability[i]);
        });
      });
    },
  );
});
