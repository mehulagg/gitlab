# frozen_string_literal: true

module API
  class VulnerabilityIssueLinks < Grape::API
    include ::API::Helpers::VulnerabilitiesHooks

    helpers ::API::Helpers::VulnerabilitiesHelpers

    helpers do
      def find_vulnerability!
        Vulnerability.find(params[:id])
      end
    end

    params do
      requires :id, type: Integer, desc: 'The ID of a vulnerability'
    end
    resource :vulnerabilities do
      desc 'Get related issues for a vulnerability' do
        success EE::API::Entities::VulnerabilityRelatedIssue
      end
      get ':id/issue_links' do
        vulnerability = find_and_authorize_vulnerability!(:read_vulnerability)

        present vulnerability
                  .related_issues
                  .with_api_entity_associations
                  .with_vulnerability_links,
                with: EE::API::Entities::VulnerabilityRelatedIssue
      end
    end
  end
end
