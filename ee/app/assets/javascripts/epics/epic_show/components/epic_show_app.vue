<script>
/* eslint-disable vue/require-default-prop */
import $ from 'jquery';
import issuableApp from '~/issue_show/components/app.vue';
import flash from '~/flash';
import { __ } from '~/locale';
import relatedIssuesRoot from 'ee/related_issues/components/related_issues_root.vue';
import epicSidebar from '../../sidebar/components/sidebar_app.vue';
import SidebarContext from '../sidebar_context';
import epicHeader from './epic_header.vue';
import EpicsService from '../../service/epics_service';
import { status, stateEvent } from '../../constants';

export default {
  name: 'EpicShowApp',
  epicsPathIdSeparator: '&',
  components: {
    epicHeader,
    epicSidebar,
    issuableApp,
    relatedIssuesRoot,
  },
  props: {
    epicId: {
      type: Number,
      required: true,
    },
    endpoint: {
      type: String,
      required: true,
    },
    updateEndpoint: {
      type: String,
      required: true,
    },
    canUpdate: {
      required: true,
      type: Boolean,
    },
    canDestroy: {
      required: true,
      type: Boolean,
    },
    canAdmin: {
      required: true,
      type: Boolean,
    },
    subepicsSupported: {
      type: Boolean,
      required: false,
      default: true,
    },
    markdownPreviewPath: {
      type: String,
      required: true,
    },
    markdownDocsPath: {
      type: String,
      required: true,
    },
    groupPath: {
      type: String,
      required: true,
    },
    initialTitleHtml: {
      type: String,
      required: true,
    },
    initialTitleText: {
      type: String,
      required: true,
    },
    initialDescriptionHtml: {
      type: String,
      required: false,
      default: '',
    },
    initialDescriptionText: {
      type: String,
      required: false,
      default: '',
    },
    created: {
      type: String,
      required: true,
    },
    author: {
      type: Object,
      required: true,
    },
    epicLinksEndpoint: {
      type: String,
      required: true,
    },
    issueLinksEndpoint: {
      type: String,
      required: true,
    },
    startDateIsFixed: {
      type: Boolean,
      required: true,
    },
    startDateFixed: {
      type: String,
      required: false,
      default: '',
    },
    startDateFromMilestones: {
      type: String,
      required: false,
      default: '',
    },
    startDate: {
      type: String,
      required: false,
    },
    dueDateIsFixed: {
      type: Boolean,
      required: true,
    },
    dueDateFixed: {
      type: String,
      required: false,
      default: '',
    },
    dueDateFromMilestones: {
      type: String,
      required: false,
      default: '',
    },
    endDate: {
      type: String,
      required: false,
    },
    startDateSourcingMilestoneTitle: {
      type: String,
      required: false,
      default: '',
    },
    startDateSourcingMilestoneDates: {
      type: Object,
      required: true,
      default: () => ({ startDate: '', dueDate: '' }),
    },
    dueDateSourcingMilestoneTitle: {
      type: String,
      required: false,
      default: '',
    },
    dueDateSourcingMilestoneDates: {
      type: Object,
      required: true,
      default: () => ({ startDate: '', dueDate: '' }),
    },
    labels: {
      type: Array,
      required: true,
    },
    parent: {
      type: Object,
      required: false,
      default: () => ({}),
    },
    participants: {
      type: Array,
      required: true,
    },
    subscribed: {
      type: Boolean,
      required: true,
    },
    todoExists: {
      type: Boolean,
      required: true,
    },
    namespace: {
      type: String,
      required: false,
      default: '#',
    },
    labelsPath: {
      type: String,
      required: true,
    },
    toggleSubscriptionPath: {
      type: String,
      required: true,
    },
    todoPath: {
      type: String,
      required: true,
    },
    todoDeletePath: {
      type: String,
      required: false,
      default: '',
    },
    labelsWebUrl: {
      type: String,
      required: true,
    },
    epicsWebUrl: {
      type: String,
      required: true,
    },
    state: {
      type: String,
      required: true,
      default: status.open,
    },
  },
  data() {
    return {
      // Epics specific configuration
      issuableRef: '',
      hasRelatedEpicsFeature: this.subepicsSupported,
      projectPath: this.groupPath,
      parentEpic: this.parent ? this.parent : {},
      projectNamespace: '',
      service: new EpicsService({
        endpoint: this.endpoint,
      }),
    };
  },
  computed: {
    open() {
      return this.state === status.open;
    },
  },
  mounted() {
    this.sidebarContext = new SidebarContext();
  },
  methods: {
    triggerDocumentEvent(eventName, isClosed) {
      $(document).trigger(eventName, isClosed);
    },
    toggleEpicStatus(stateEventType) {
      return this.service
        .updateStatus(stateEventType)
        .then(() => {
          const isClosed = stateEventType === stateEvent.close;

          // Ensure that status change is reflected across the page.
          // As `Close`/`Reopen` button is also present under
          // comment form (part of Notes app)
          // We've wrapped call to `$(document).trigger` for ease of testing
          this.triggerDocumentEvent('issuable_vue_app:change', isClosed);
          this.triggerDocumentEvent('issuable:change', isClosed);
        })
        .catch(() => {
          flash(__('Unable to update this epic at this time.'));
          const isClosed = stateEventType !== stateEvent.close;
          this.triggerDocumentEvent('issuable_vue_app:change', isClosed);
          this.triggerDocumentEvent('issuable:change', isClosed);
        });
    },
  },
};
</script>

<template>
  <div class="epic-page-container">
    <epic-header
      :author="author"
      :created="created"
      :open="open"
      :can-delete="canDestroy"
      :can-update="canUpdate"
      @toggleEpicStatus="toggleEpicStatus"
    />
    <div class="issuable-details content-block">
      <div class="detail-page-description">
        <issuable-app
          :can-update="canUpdate"
          :can-destroy="canDestroy"
          :endpoint="endpoint"
          :update-endpoint="updateEndpoint"
          :issuable-ref="issuableRef"
          :initial-title-html="initialTitleHtml"
          :initial-title-text="initialTitleText"
          :initial-description-html="initialDescriptionHtml"
          :initial-description-text="initialDescriptionText"
          :markdown-preview-path="markdownPreviewPath"
          :markdown-docs-path="markdownDocsPath"
          :project-path="projectPath"
          :project-namespace="projectNamespace"
          :show-inline-edit-button="true"
          :show-delete-button="canDestroy"
          :enable-autocomplete="true"
          issuable-type="epic"
        />
      </div>
      <epic-sidebar
        :epic-id="epicId"
        :endpoint="endpoint"
        :editable="canUpdate"
        :initial-start-date-is-fixed="startDateIsFixed"
        :initial-start-date-fixed="startDateFixed"
        :start-date-from-milestones="startDateFromMilestones"
        :initial-start-date="startDate"
        :initial-due-date-is-fixed="dueDateIsFixed"
        :initial-due-date-fixed="dueDateFixed"
        :due-date-from-milestones="dueDateFromMilestones"
        :initial-end-date="endDate"
        :start-date-sourcing-milestone-title="startDateSourcingMilestoneTitle"
        :start-date-sourcing-milestone-dates="startDateSourcingMilestoneDates"
        :due-date-sourcing-milestone-title="dueDateSourcingMilestoneTitle"
        :due-date-sourcing-milestone-dates="dueDateSourcingMilestoneDates"
        :initial-labels="labels"
        :initial-participants="participants"
        :initial-subscribed="subscribed"
        :initial-todo-exists="todoExists"
        :parent="parentEpic"
        :namespace="namespace"
        :update-path="updateEndpoint"
        :labels-path="labelsPath"
        :toggle-subscription-path="toggleSubscriptionPath"
        :todo-path="todoPath"
        :todo-delete-path="todoDeletePath"
        :labels-web-url="labelsWebUrl"
        :epics-web-url="epicsWebUrl"
      />
      <related-issues-root
        v-if="hasRelatedEpicsFeature"
        :endpoint="epicLinksEndpoint"
        :can-admin="canAdmin"
        :can-reorder="canAdmin"
        :allow-auto-complete="false"
        :path-id-separator="$options.epicsPathIdSeparator"
        :title="__('Epics')"
        :issuable-type="__('epic')"
        css-class="js-related-epics-block"
      />
      <related-issues-root
        :endpoint="issueLinksEndpoint"
        :can-admin="canAdmin"
        :can-reorder="canAdmin"
        :allow-auto-complete="false"
        :title="__('Issues')"
        :issuable-type="__('issue')"
        css-class="js-related-issues-block"
        path-id-separator="#"
      />
    </div>
  </div>
</template>
