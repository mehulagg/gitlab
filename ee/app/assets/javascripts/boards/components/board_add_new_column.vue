<script>
import {
  GlAvatarLabeled,
  GlIcon,
  GlFormGroup,
  GlFormRadio,
  GlFormRadioGroup,
  GlFormSelect,
  GlTooltipDirective as GlTooltip,
} from '@gitlab/ui';
import { mapActions, mapGetters, mapState } from 'vuex';
import BoardAddNewColumnForm from '~/boards/components/board_add_new_column_form.vue';
import { ListType, ListTypeTitles } from '~/boards/constants';
import boardsStore from '~/boards/stores/boards_store';
import { getIdFromGraphQLId } from '~/graphql_shared/utils';
import { isScopedLabel } from '~/lib/utils/common_utils';
import { __ } from '~/locale';

export default {
  i18n: {
    listType: __('Scope'),
    scopeDescription: __('Issues in the list will be filtered by this scope'),
    labelListDescription: __('A label list displays issues with the selected label.'),
    assigneeListDescription: __('An assignee list displays issues assigned to the selected user'),
    milestoneListDescription: __('A milestone list displays issues in the selected milestone.'),
    iterationListDescription: __('An iteration list displays issues in the selected iteration.'),
    selectLabel: __('Select label'),
    selectAssignee: __('Select assignee'),
    selectMilestone: __('Select milestone'),
    selectIteration: __('Select iteration'),
    searchLabels: __('Search labels'),
    searchAssignees: __('Search assignees'),
    searchMilestones: __('Search milestones'),
    searchIterations: __('Search iterations'),
  },
  columnTypes: [
    { value: ListType.label, text: __('Label') },
    { value: ListType.assignee, text: __('Assignee') },
    { value: ListType.milestone, text: __('Milestone') },
    { value: ListType.iteration, text: __('Iteration') },
  ],
  components: {
    BoardAddNewColumnForm,
    GlAvatarLabeled,
    GlIcon,
    GlFormGroup,
    GlFormRadio,
    GlFormRadioGroup,
  },
  directives: {
    GlTooltip,
  },
  inject: ['scopedLabelsAvailable'],
  data() {
    return {
      selectedId: null,
      columnType: ListType.label,
    };
  },
  computed: {
    ...mapState([
      'labels',
      'labelsLoading',
      'milestones',
      'milestonesLoading',
      'iterations',
      'iterationsLoading',
      'assignees',
      'assigneesLoading',
    ]),
    ...mapGetters(['getListByTypeId', 'shouldUseGraphQL', 'isEpicBoard']),

    items() {
      if (this.labelTypeSelected) {
        return this.labels;
      }
      if (this.assigneeTypeSelected) {
        return this.assignees;
      }
      if (this.milestoneTypeSelected) {
        return this.milestones;
      }
      if (this.iterationTypeSelected) {
        return this.iterations;
      }
      return [];
    },

    labelTypeSelected() {
      return this.columnType === ListType.label;
    },
    assigneeTypeSelected() {
      return this.columnType === ListType.assignee;
    },
    milestoneTypeSelected() {
      return this.columnType === ListType.milestone;
    },
    iterationTypeSelected() {
      return this.columnType === ListType.iteration;
    },

    selectedLabel() {
      if (!this.labelTypeSelected) {
        return null;
      }
      return this.labels.find(({ id }) => id === this.selectedId);
    },
    selectedAssignee() {
      if (!this.assigneeTypeSelected) {
        return null;
      }
      return this.assignees.find(({ id }) => id === this.selectedId);
    },
    selectedMilestone() {
      if (!this.milestoneTypeSelected) {
        return null;
      }
      return this.milestones.find(({ id }) => id === this.selectedId);
    },
    selectedIteration() {
      if (!this.iterationTypeSelected) {
        return null;
      }
      return this.iterations.find(({ id }) => id === this.selectedId);
    },
    selectedItem() {
      if (!this.selectedId) {
        return null;
      }
      if (this.labelTypeSelected) {
        return this.selectedLabel;
      }
      if (this.assigneeTypeSelected) {
        return this.selectedAssignee;
      }
      if (this.milestoneTypeSelected) {
        return this.selectedMilestone;
      }
      if (this.iterationTypeSelected) {
        return this.selectedIteration;
      }
      return null;
    },

    columnForSelected() {
      if (!this.columnType) {
        return false;
      }

      const key = `${this.columnType}Id`;
      return this.getListByTypeId({
        [key]: this.selectedId,
      });
    },

    loading() {
      if (this.labelTypeSelected) {
        return this.labelsLoading;
      }
      if (this.assigneeTypeSelected) {
        return this.assigneesLoading;
      }
      if (this.milestoneTypeSelected) {
        return this.milestonesLoading;
      }
      if (this.iterationTypeSelected) {
        return this.iterationsLoading;
      }
      return false;
    },

    formLabel() {
      return ListTypeTitles[this.columnType];
    },

    formDescription() {
      if (this.labelTypeSelected) {
        return this.$options.i18n.labelListDescription;
      }

      if (this.assigneeTypeSelected) {
        return this.$options.i18n.assigneeListDescription;
      }

      if (this.milestoneTypeSelected) {
        return this.$options.i18n.milestoneListDescription;
      }

      if (this.iterationTypeSelected) {
        return this.$options.i18n.iterationListDescription;
      }

      return null;
    },

    searchLabel() {
      if (this.labelTypeSelected) {
        return this.$options.i18n.selectLabel;
      }

      if (this.assigneeTypeSelected) {
        return this.$options.i18n.selectAssignee;
      }

      if (this.milestoneTypeSelected) {
        return this.$options.i18n.selectMilestone;
      }

      if (this.iterationTypeSelected) {
        return this.$options.i18n.selectIteration;
      }

      return null;
    },

    searchPlaceholder() {
      if (this.labelTypeSelected) {
        return this.$options.i18n.searchLabels;
      }

      if (this.assigneeTypeSelected) {
        return this.$options.i18n.searchAssignees;
      }

      if (this.milestoneTypeSelected) {
        return this.$options.i18n.searchMilestones;
      }

      if (this.iterationTypeSelected) {
        return this.$options.i18n.searchIterations;
      }

      return null;
    },
  },
  created() {
    this.filterItems();
  },
  methods: {
    ...mapActions([
      'createList',
      'fetchLabels',
      'highlightList',
      'setAddColumnFormVisibility',
      'fetchAssignees',
      'fetchIterations',
      'fetchMilestones',
    ]),
    highlight(listId) {
      if (this.shouldUseGraphQL || this.isEpicBoard) {
        this.highlightList(listId);
      } else {
        const list = boardsStore.state.lists.find(({ id }) => id === listId);
        list.highlighted = true;
        setTimeout(() => {
          list.highlighted = false;
        }, 2000);
      }
    },
    addList() {
      if (!this.selectedItem) {
        return;
      }

      this.setAddColumnFormVisibility(false);

      if (this.columnForSelected) {
        const listId = this.columnForSelected.id;
        this.highlight(listId);
        return;
      }

      if (this.shouldUseGraphQL || this.isEpicBoard) {
        // eslint-disable-next-line @gitlab/require-i18n-strings
        this.createList({ [`${this.columnType}Id`]: this.selectedId });
      } else {
        const { length } = boardsStore.state.lists;
        const position = this.hideClosed ? length - 1 : length - 2;
        const listObj = {
          // eslint-disable-next-line @gitlab/require-i18n-strings
          [`${this.columnType}Id`]: getIdFromGraphQLId(this.selectedId),
          title: this.selectedItem.title,
          position,
          list_type: this.columnType,
        };

        if (this.labelTypeSelected) {
          listObj.label = this.selectedLabel;
        } else if (this.milestoneTypeSelected) {
          listObj.milestone = {
            ...this.selectedMilestone,
            id: getIdFromGraphQLId(this.selectedMilestone.id),
          };
        } else if (this.iterationTypeSelected) {
          listObj.iteration = {
            ...this.selectedIteration,
            id: getIdFromGraphQLId(this.selectedIteration.id),
          };
        } else if (this.assigneeTypeSelected) {
          listObj.assignee = {
            ...this.selectedAssignee,
            id: getIdFromGraphQLId(this.selectedAssignee.id),
          };
        }

        boardsStore.new(listObj);
      }
    },

    filterItems(searchTerm) {
      switch (this.columnType) {
        case ListType.iteration:
          this.fetchIterations(searchTerm);
          break;
        case ListType.milestone:
          this.fetchMilestones(searchTerm);
          break;
        case ListType.assignee:
          this.fetchAssignees(searchTerm);
          break;
        case ListType.label:
        default:
          this.fetchLabels(searchTerm);
      }
    },

    showScopedLabels(label) {
      return this.scopedLabelsAvailable && isScopedLabel(label);
    },

    setColumnType(type) {
      this.columnType = type;
      this.selectedId = null;
      this.filterItems();
    },
  },
};
</script>

<template>
  <board-add-new-column-form
    :loading="loading"
    :form-label="formLabel"
    :form-description="formDescription"
    :search-label="searchLabel"
    :search-placeholder="searchPlaceholder"
    :selected-id="selectedId"
    @filter-items="filterItems"
    @add-list="addList"
  >
    <template slot="select-list-type">
      <gl-form-group
        v-if="!isEpicBoard"
        :label="$options.i18n.listType"
        :description="$options.i18n.scopeDescription"
        class="gl-px-5 gl-py-0 gl-mt-5"
        label-for="list-type"
      >
        <gl-form-radio-group v-model="columnType">
          <gl-form-radio
            v-for="{ text, value } in $options.columnTypes"
            :key="value"
            :value="value"
            class="gl-mb-0 gl-align-self-center"
            @change="setColumnType"
          >
            {{ text }}
          </gl-form-radio>
        </gl-form-radio-group>
      </gl-form-group>
    </template>

    <template slot="selected">
      <div v-if="selectedLabel" class="gl-display-flex gl-flex-align-items-center">
        <span
          class="dropdown-label-box gl-top-0"
          :style="{
            backgroundColor: selectedItem.color,
          }"
        ></span>
        {{ selectedItem.title }}
      </div>

      <div
        v-else-if="selectedMilestone"
        class="gl-text-truncate gl-display-flex gl-flex-align-items-center"
      >
        <gl-icon name="clock" />
        <span>{{ selectedItem.title }}</span>
      </div>

      <div v-else-if="selectedIteration" class="gl-text-truncate">
        <gl-icon name="iteration" />
        <span>{{ selectedItem.title }}</span>
      </div>

      <div
        v-else-if="selectedAssignee"
        class="gl-text-truncate gl-display-flex gl-flex-align-items-center"
      >
        <gl-avatar-labeled
          inline
          :size="16"
          :label="selectedItem.name"
          :sub-label="selectedItem.username"
          :src="selectedItem.avatarUrl"
        />
      </div>
    </template>

    <template slot="items">
      <gl-form-radio-group
        v-if="items.length > 0"
        v-model="selectedId"
        class="gl-overflow-y-auto gl-px-5"
        @change="$root.$emit('bv::dropdown::hide')"
      >
        <label
          v-for="item in items"
          :key="item.id"
          class="gl-display-flex gl-flex-align-items-center gl-mt-3 gl-font-weight-normal"
        >
          <gl-form-radio :value="item.id" class="gl-mb-0 gl-align-self-center" />
          <span
            v-if="labelTypeSelected"
            class="dropdown-label-box gl-top-0"
            :style="{
              backgroundColor: item.color,
            }"
          ></span>

          <gl-avatar-labeled
            v-if="assigneeTypeSelected"
            :size="32"
            :label="item.name"
            :sub-label="item.username"
            :src="item.avatarUrl"
          />
          <span v-else>{{ item.title }}</span>
        </label>
      </gl-form-radio-group>
    </template>
  </board-add-new-column-form>
</template>
