<script>
import { GlLoadingIcon } from '@gitlab/ui';
import GroupSecurityVulnerabilities from 'ee/security_dashboard/components/first_class_group_security_dashboard_vulnerabilities.vue';
import InstanceSecurityVulnerabilities from 'ee/security_dashboard/components/first_class_instance_security_dashboard_vulnerabilities.vue';
import Filters from 'ee/security_dashboard/components/first_class_vulnerability_filters.vue';
import SecurityDashboardLayout from 'ee/security_dashboard/components/security_dashboard_layout.vue';
import { DASHBOARD_TYPES } from 'ee/security_dashboard/store/constants';
import { s__ } from '~/locale';
import { vulnerabilitiesSeverityCountScopes } from '../constants';
import vulnerableProjectsGroupQuery from '../graphql/queries/vulnerable_projects_group.query.graphql';
import vulnerableProjectsInstanceQuery from '../graphql/queries/vulnerable_projects_instance.query.graphql';
import CsvExportButton from './csv_export_button.vue';
import DashboardNotConfiguredGroup from './empty_states/group_dashboard_not_configured.vue';
import DashboardNotConfiguredInstance from './empty_states/instance_dashboard_not_configured.vue';
import SurveyRequestBanner from './survey_request_banner.vue';
import VulnerabilitiesCountList from './vulnerability_count_list.vue';

export default {
  components: {
    SecurityDashboardLayout,
    GroupSecurityVulnerabilities,
    InstanceSecurityVulnerabilities,
    Filters,
    CsvExportButton,
    SurveyRequestBanner,
    DashboardNotConfiguredGroup,
    DashboardNotConfiguredInstance,
    GlLoadingIcon,
    VulnerabilitiesCountList,
  },
  inject: ['groupFullPath'],
  props: {
    dashboardType: {
      type: String,
      required: true,
      validator: (value) => Object.values(DASHBOARD_TYPES).includes(value),
    },
  },
  queries: {
    [DASHBOARD_TYPES.GROUP]: vulnerableProjectsGroupQuery,
    [DASHBOARD_TYPES.INSTANCE]: vulnerableProjectsInstanceQuery,
  },
  apollo: {
    projects: {
      query() {
        return this.$options.queries[this.dashboardType];
      },
      variables() {
        return this.isGroup ? { fullPath: this.groupFullPath } : {};
      },
      update(data) {
        return this.isGroup
          ? data.group.projects.nodes
          : data.instanceSecurityDashboard.projects.nodes;
      },
      skip() {
        return !this.$options.queries[this.dashboardType];
      },
    },
  },
  data() {
    return {
      filters: null,
      projects: [],
    };
  },
  computed: {
    projectsWereFetched() {
      return !this.$apollo.queries.projects?.loading;
    },
    scope() {
      return this.isGroup
        ? vulnerabilitiesSeverityCountScopes.group
        : vulnerabilitiesSeverityCountScopes.instance;
    },
    isGroup() {
      return this.dashboardType === DASHBOARD_TYPES.GROUP;
    },
    isInstance() {
      return this.dashboardType === DASHBOARD_TYPES.INSTANCE;
    },
    hasNoProjects() {
      return this.projects.length === 0 && this.projectsWereFetched;
    },
  },
  methods: {
    handleFilterChange(filters) {
      this.filters = filters;
    },
  },
  i18n: {
    title: s__('SecurityReports|Vulnerability Report'),
  },
};
</script>

<template>
  <div>
    <gl-loading-icon v-if="!projectsWereFetched" size="lg" class="gl-mt-6" />
    <template v-else-if="hasNoProjects">
      <survey-request-banner class="gl-mt-5" />
      <dashboard-not-configured-group v-if="isGroup" />
      <dashboard-not-configured-instance v-else-if="isInstance" />
    </template>
    <security-dashboard-layout v-else>
      <template #header>
        <survey-request-banner class="gl-mt-5" />
        <header class="gl-my-6 gl-display-flex gl-align-items-center">
          <h2 class="gl-flex-grow-1 gl-my-0">
            {{ $options.i18n.title }}
          </h2>
          <csv-export-button />
        </header>
        <vulnerabilities-count-list :scope="scope" :full-path="groupFullPath" :filters="filters" />
      </template>
      <template #sticky>
        <filters :projects="projects" @filterChange="handleFilterChange" />
      </template>
      <group-security-vulnerabilities v-if="isGroup" :filters="filters" />
      <instance-security-vulnerabilities v-if="isInstance" :filters="filters" />
    </security-dashboard-layout>
  </div>
</template>
