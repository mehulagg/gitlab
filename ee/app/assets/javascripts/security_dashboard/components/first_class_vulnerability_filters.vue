<script>
import { debounce, isEqual } from 'lodash';
import createFlash from '~/flash';
import glFeatureFlagsMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import groupProjects from '../graphql/queries/group_projects.query.graphql';
import instanceProjects from '../graphql/queries/instance_projects.query.graphql';
import {
  stateFilter,
  severityFilter,
  scannerFilter,
  activityFilter,
  getProjectFilter,
  PROJECT_LOADING_ERROR_MESSAGE,
} from '../helpers';
import { DASHBOARD_TYPES } from '../store/constants';
import ActivityFilter from './filters/activity_filter.vue';
import ScannerFilter from './filters/scanner_filter.vue';
import StandardFilter from './filters/standard_filter.vue';

const PROJECT_FILTER_DASHBOARD_TYPES = [DASHBOARD_TYPES.GROUP, DASHBOARD_TYPES.INSTANCE];

const QUERY_CONFIGS = {
  [DASHBOARD_TYPES.GROUP]: {
    query: groupProjects,
    root: 'group',
  },
  [DASHBOARD_TYPES.INSTANCE]: {
    query: instanceProjects,
    root: 'instanceSecurityDashboard',
  },
};

export default {
  components: { StandardFilter, ScannerFilter, ActivityFilter },
  mixins: [glFeatureFlagsMixin()],
  inject: ['dashboardType', 'groupFullPath'],
  data() {
    return {
      filterQuery: {},
      projects: [],
    };
  },
  apollo: {
    projects: {
      query() {
        return this.queryConfig.query;
      },
      variables() {
        return { fullPath: this.groupFullPath };
      },
      update(data) {
        return data[this.queryConfig.root].projects.nodes;
      },
      error() {
        createFlash({ message: PROJECT_LOADING_ERROR_MESSAGE });
      },
    },
  },
  computed: {
    standardFilters() {
      return this.shouldShowCustomScannerFilter
        ? [stateFilter, severityFilter]
        : [stateFilter, severityFilter, scannerFilter];
    },
    shouldShowProjectFilter() {
      return PROJECT_FILTER_DASHBOARD_TYPES.includes(this.dashboardType);
    },
    shouldShowCustomScannerFilter() {
      return this.glFeatures.customSecurityScanners;
    },
    queryConfig() {
      return QUERY_CONFIGS[this.dashboardType];
    },
    projectFilter() {
      return getProjectFilter(this.projects);
    },
    isLoadingProjects() {
      return this.$apollo.queries.projects.loading;
    },
  },
  watch: {
    filterQuery(newQuery, oldQuery) {
      if (!isEqual(newQuery, oldQuery)) {
        this.emitFilterChange();
      }
    },
  },
  methods: {
    updateFilterQuery(query) {
      this.filterQuery = { ...this.filterQuery, ...query };
    },
    // When this component is first shown, every filter will emit its own @filter-changed event at,
    // which will trigger this method multiple times. We'll debounce it so that it only runs once.
    emitFilterChange: debounce(function emit() {
      this.$emit('filterChange', this.filterQuery);
    }),
  },
  scannerFilter,
  activityFilter,
};
</script>

<template>
  <div
    class="vulnerability-report-filters gl-p-5 gl-bg-gray-10 gl-border-b-1 gl-border-b-solid gl-border-b-gray-100"
  >
    <standard-filter
      v-for="filter in standardFilters"
      :key="filter.id"
      :filter="filter"
      :data-testid="filter.id"
      @filter-changed="updateFilterQuery"
    />
    <scanner-filter
      v-if="shouldShowCustomScannerFilter"
      :filter="$options.scannerFilter"
      @filter-changed="updateFilterQuery"
    />
    <activity-filter :filter="$options.activityFilter" @filter-changed="updateFilterQuery" />
    <standard-filter
      v-if="shouldShowProjectFilter"
      :filter="projectFilter"
      :loading="isLoadingProjects"
      @filter-changed="updateFilterQuery"
    />
  </div>
</template>
