<script>
import {
  GlAlert,
  GlAvatar,
  GlBadge,
  GlLink,
  GlPagination,
  GlTab,
  GlTabs,
  GlTable,
  GlTooltipDirective,
} from '@gitlab/ui';
import { __ } from '~/locale';
import { getParameterByName } from '~/lib/utils/common_utils';
import { getIdFromGraphQLId } from '~/graphql_shared/utils';
import query from '../queries/iteration_issues.query.graphql';

const issuesPerPage = 20;

const states = {
  opened: 'opened',
  closed: 'closed',
};

const initialPaginationState = {
  currentPage: 1,
  nextPageCursor: '',
};

export default {
  fields: [
    {
      key: 'title',
      label: __('Title'),
      thClass: 'w-30p',
      tdClass: 'table-col d-flex align-items-center d-sm-table-cell',
    },
    {
      key: 'status',
      label: __('Status'),
      thClass: 'w-30p',
      tdClass: 'table-col d-flex align-items-center d-sm-table-cell',
      class: 'text-truncate',
    },
    {
      key: 'assignees',
      label: __('Assignees'),
      class: 'text-right',
      thClass: 'w-30p',
      tdClass: 'table-col d-flex align-items-center d-sm-table-cell',
    },
  ],
  components: {
    GlAlert,
    GlAvatar,
    GlBadge,
    GlLink,
    GlPagination,
    GlTab,
    GlTabs,
    GlTable,
  },
  directives: {
    GlTooltip: GlTooltipDirective,
  },
  apollo: {
    issues: {
      query,
      variables() {
        return this.queryVariables;
      },
      update(data) {
        const issues = data?.group?.issues?.nodes || [];
        const totalCount = data?.group?.issues?.totalCount;
        const pageInfo = data?.group?.issues?.pageInfo || {};

        const list = issues.map(issue => ({
          ...issue,
          labels: issue?.labels?.nodes || [],
          assignees: issue?.assignees?.nodes || [],
        }));

        return {
          pageInfo,
          list,
          totalCount,
        };
      },
      error() {
        this.error = __('Error loading issues');
      },
    },
  },
  props: {
    groupPath: {
      type: String,
      required: true,
    },
    iterationId: {
      type: String,
      required: true,
    },
  },
  data() {
    return {
      issues: {
        list: [],
        pageInfo: {
          nextPageCursor: '',
        },
      },
      error: '',
      pagination: initialPaginationState,
    };
  },
  computed: {
    queryVariables() {
      return {
        groupPath: this.groupPath,
        id: getIdFromGraphQLId(this.iterationId),
        nextPageCursor: this.pagination.nextPageCursor,
      };
    },

    prevPage() {
      return Math.max(this.pagination.currentPage - 1, 0);
    },
    nextPage() {
      const nextPage = this.pagination.currentPage + 1;
      return nextPage > Math.ceil(this.issues.totalCount / issuesPerPage) ? null : nextPage;
    },
  },
  methods: {
    issueState(state, assigneeCount) {
      if (state === states.opened && assigneeCount === 0) {
        return __('Open');
      }
      if (state === states.opened && assigneeCount > 0) {
        return __('In progress');
      }
      return __('Closed');
    },
    handlePageChange(page) {
      const { startCursor, endCursor, hasNextPage, hasPreviousPage } = this.issues.pageInfo;

      if (page > this.pagination.currentPage) {
        this.pagination = {
          ...initialPaginationState,
          nextPageCursor: endCursor,
          currentPage: page,
          hasNextPage,
          hasPreviousPage,
        };
      } else {
        this.pagination = {
          lastPageSize: 5,
          firstPageSize: null,
          prevPageCursor: startCursor,
          nextPageCursor: '',
          currentPage: page,
        };
      }
    },
  },
};
</script>

<template>
  <gl-tabs>
    <gl-alert v-if="error" variant="danger" @dismiss="error = ''">
      {{ error }}
    </gl-alert>
    <gl-tab title="Issues">
      <template #title>
        <span>{{ __('Issues') }}</span
        ><gl-badge class="ml-2" variant="neutral">{{ issues.totalCount }}</gl-badge>
      </template>

      <gl-table :items="issues.list" :fields="$options.fields" :show-empty="true">
        <template #cell(title)="{ item: { iid, title, webUrl } }">
          <div class="text-truncate">
            <gl-link class="gl-text-gray-900 gl-font-weight-bold" :href="webUrl">{{
              title
            }}</gl-link>
            <!-- TODO: add references.relative (project name) -->
            <div class="gl-text-secondary">#{{ iid }}</div>
          </div>
        </template>

        <template #cell(status)="{ item: { state, assignees } }">
          <span class="gl-w-6 flex-shrink-0">{{ issueState(state, assignees.length) }}</span>
        </template>

        <template #cell(assignees)="{ item: { assignees } }">
          <span class="assignee-icon gl-w-6">
            <span
              v-for="assignee in assignees"
              :key="assignee.username"
              v-gl-tooltip="
                sprintf(__('Assigned to %{assigneeName}'), {
                  assigneeName: assignee.name,
                })
              "
            >
              <gl-avatar :src="assignee.avatarUrl" :size="16" />
            </span>
          </span>
        </template>
      </gl-table>
      <div class="mt-3">
        <gl-pagination
          :value="pagination.currentPage"
          :prev-page="prevPage"
          :next-page="nextPage"
          align="center"
          class="gl-pagination gl-mt-3"
          @input="handlePageChange"
        />
      </div>
    </gl-tab>
  </gl-tabs>
</template>
