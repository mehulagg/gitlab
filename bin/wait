#!/usr/bin/env ruby

require 'net/http'
require 'uri'

class ServiceCheck
  def initialize(url)
    @uri = URI.join(url, '/help')
  end

  def check(retries)
    retries.times do
      return true if service_available?

      print '.'
      sleep 1
    end

    false
  end

  private

  def service_available?
    response = Net::HTTP.start(@uri.host, @uri.port) do |http|
      http.head2(@uri.request_uri)
    end

    response.code.to_i == 200
  rescue Errno::ECONNREFUSED
    false
  end
end

puts "GITLAB_URL: #{ENV['GITLAB_URL']}"
print 'Waiting for GitLab to become available '

if ServiceCheck.new(ENV['GITLAB_URL']).check(180)
  sleep 12 # TODO
  puts ' -> GitLab is available.'
else
  abort ' -> GitLab unavailable!'
end
