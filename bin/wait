#!/bin/bash

echo "GITLAB_URL: ${GITLAB_URL}"
echo -n "Waiting for GitLab to become available"

i=0
available=0
while [[ $i -lt 30 ]]; do
    echo -n "."

    curl --silent --head --fail --output /dev/null \
         --retry 10 --retry-delay 1 \
         --max-time 2 --retry-max-time 30 \
         $GITLAB_URL

    if [ "$?" -eq 0 ]; then
        available=1
        break
    fi

    i=`expr $i + 1`
    sleep 1
done

if [ "$available" -eq 1 ]; then
  echo -e "\n\033[32;1mGitLab service is available!\033[0m"
else
  echo -e "\n\033[31;1mGitLab service is not available!\033[0m"
  exit 1
fi
