#!/bin/sh

cd $(dirname $0)/..
app_root=$(pwd)
sidekiq_pidfile="$app_root/tmp/pids/sidekiq-cluster.pid"
gitlab_user=$(ls -l config.ru | awk '{print $3}')
rails_env=${RAILS_ENV:-development}

warn()
{
  echo "$@" 1>&2
}

read_sidekiq_pid() {
  if [ ! -f $sidekiq_pidfile ]; then
    warn "No pidfile found at $sidekiq_pidfile; is Sidekiq running?"
    return
  fi

  cat $sidekiq_pidfile
}

stop()
{
  sidekiq_pid=$(read_sidekiq_pid)
  [ ! $sidekiq_pid ] && exit 1
  kill -TERM $sidekiq_pid
}

killall()
{
  pkill -u $gitlab_user -f 'sidekiq [0-9]'
}

start()
{
  shift # remove self
  sidekiq_processes=${1:-2}
  cmd="exec"
  chpst=$(which chpst)

  # TODO: this is also done in the runit `run` script; remove?
  if [ -n "$chpst" ]; then
    cmd="${cmd} ${chpst} -P"
  fi

  ${cmd} ee/bin/sidekiq-cluster -p $sidekiq_processes -P $sidekiq_pidfile -e $rails_env
}

load_ok()
{
  sidekiq_pid=$(read_sidekiq_pid)
  if [ -z "$sidekiq_pid" ] ; then
    warn "Could not find a PID in $sidekiq_pidfile"
    exit 0
  fi

  if (ps -p $sidekiq_pid -o args | grep '\([0-9]\+\) of \1 busy' 1>&2) ; then
    warn "Too many busy Sidekiq workers"
    exit 1
  fi

  exit 0
}

case "$1" in
  stop)
    stop
    ;;
  start)
    start $@
    ;;
  start_foreground)
    warn '--'
    warn "NOTE: The start_foreground task is deprecated and will be removed soon. Use 'start' instead."
    warn '--'
    start $@
    ;;
  killall)
    killall
    ;;
  load_ok)
    load_ok
    ;;
  *)
    echo "Usage: RAILS_ENV=<env> $0 {stop|start <num_workers>|killall|load_ok}"
esac
