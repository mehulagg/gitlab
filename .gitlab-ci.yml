# You can override the included template(s) by including variable overrides
# See https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#priority-of-environment-variables
stages:
- sync
- prepare
- build-images
- fixtures
- test
- post-test
- review-prepare
- review
- dast
- qa
- post-qa
- pages
- notify
default:
  image: registry.gitlab.com/gitlab-org/gitlab-build-images:ruby-2.7.2-golang-1.14-git-2.29-lfs-2.9-chrome-85-node-12.18-yarn-1.22-postgresql-11-graphicsmagick-1.3.34
  tags:
  - gitlab-org
  interruptible: true
  timeout: 90m
workflow:
  rules:
  - if: "$FORCE_GITLAB_CI"
  - if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^release-tools\/\d+\.\d+\.\d+-rc\d+$/
      && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^[\d-]+-stable(-ee)?$/ && $CI_PROJECT_PATH
      == "gitlab-org/gitlab"
    when: never
  - if: "$CI_MERGE_REQUEST_IID"
  - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
  - if: "$CI_COMMIT_TAG"
  - if: "$GITLAB_INTERNAL == null"
    when: never
  - if: "$CI_COMMIT_BRANCH =~ /^[\\d-]+-stable(-ee)?$/"
  - if: "$CI_COMMIT_BRANCH =~ /^\\d+-\\d+-auto-deploy-\\d+$/"
  - if: "$CI_COMMIT_BRANCH =~ /^security\\//"
variables:
  RAILS_ENV: test
  NODE_ENV: test
  SIMPLECOV: 'true'
  GIT_DEPTH: '20'
  GIT_SUBMODULE_STRATEGY: none
  GET_SOURCES_ATTEMPTS: '3'
  KNAPSACK_RSPEC_SUITE_REPORT_PATH: knapsack/report-master.json
  FLAKY_RSPEC_SUITE_REPORT_PATH: rspec_flaky/report-suite.json
  RSPEC_TESTS_MAPPING_PATH: crystalball/mapping.json
  RSPEC_PACKED_TESTS_MAPPING_PATH: crystalball/packed-mapping.json
  BUILD_ASSETS_IMAGE: 'false'
  ES_JAVA_OPTS: "-Xms256m -Xmx256m"
  ELASTIC_URL: http://elastic:changeme@elasticsearch:9200
  DOCKER_VERSION: 19.03.0
  CACHE_CLASSES: 'true'
  GIT_CLONE_PATH: "/builds/gitlab-org-forks/${CI_PROJECT_NAME}"
include:
- local: ".gitlab/ci/build-images.gitlab-ci.yml"
- local: ".gitlab/ci/cache-repo.gitlab-ci.yml"
- local: ".gitlab/ci/cng.gitlab-ci.yml"
- local: ".gitlab/ci/docs.gitlab-ci.yml"
- local: ".gitlab/ci/frontend.gitlab-ci.yml"
- local: ".gitlab/ci/global.gitlab-ci.yml"
- local: ".gitlab/ci/memory.gitlab-ci.yml"
- local: ".gitlab/ci/pages.gitlab-ci.yml"
- local: ".gitlab/ci/qa.gitlab-ci.yml"
- local: ".gitlab/ci/reports.gitlab-ci.yml"
- local: ".gitlab/ci/rails.gitlab-ci.yml"
- local: ".gitlab/ci/review.gitlab-ci.yml"
- local: ".gitlab/ci/rules.gitlab-ci.yml"
- local: ".gitlab/ci/setup.gitlab-ci.yml"
- local: ".gitlab/ci/dev-fixtures.gitlab-ci.yml"
- local: ".gitlab/ci/test-metadata.gitlab-ci.yml"
- local: ".gitlab/ci/yaml.gitlab-ci.yml"
- local: ".gitlab/ci/releases.gitlab-ci.yml"
- local: ".gitlab/ci/notify.gitlab-ci.yml"
- local: ".gitlab/ci/dast.gitlab-ci.yml"
- local: ".gitlab/ci/workhorse.gitlab-ci.yml"
- template: Security/SAST.gitlab-ci.yml
sast:
  stage: test
