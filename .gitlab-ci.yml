services:
 - docker:1.12-dind

stages:
  - build
  - check
  - test

variables:
  TEST_IMAGE_NAME: registry.gitlab.com/gitlab-org/gitlab-qa
  TEST_IMAGE: $TEST_IMAGE_NAME:latest
  DOCKER_DRIVER: overlay
  DOCKER_HOST: tcp://docker:2375

# Workaround for gitlab-org/gitlab-ce#22598
#
build:stub:
  stage: build
  script: echo 'Starting pipeline ...'

build:image:
  image: docker:1.12
  stage: build
  script:
    - ./bin/docker load
    - ./bin/docker build
    - ./bin/docker store
    - test -n "$CI_BUILD_TOKEN" || exit 0
    - ./bin/docker publish
  except:
    - triggers
    - master
  tags:
    - docker
  when: manual
  cache:
    key: "docker-build-cache"
    paths:
      - ./latest_image.tar

check:rubocop:
  stage: check
  image: ruby:2.3
  script:
    - gem install rubocop
    - rubocop
  except:
    - triggers
  tags:
    - docker

check:rspec:
  stage: check
  image: $TEST_IMAGE
  script: bin/test Internal::Unit
  except:
    - triggers
  tags:
    - docker

ce:instance:
  stage: test
  image: $TEST_IMAGE
  script: bin/test Instance::CE
  tags:
    - docker
  artifacts:
    when: on_failure
    paths:
      - tmp/*.png

ee:instance:
  image: $TEST_IMAGE
  stage: test
  script: bin/test Instance::EE
  tags:
    - docker
  artifacts:
    when: on_failure
    paths:
      - tmp/*.png

ce:image:
  image: $TEST_IMAGE
  stage: test
  script: bin/test Omnibus::Image CE
  tags:
     - docker

ee:image:
  image: $TEST_IMAGE
  stage: test
  script: bin/test Omnibus::Image EE
  tags:
     - docker
