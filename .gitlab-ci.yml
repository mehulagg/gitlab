# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/#customizing-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#priority-of-environment-variables
stages:
- sync
- prepare
- build-images
- fixtures
- test
- post-test
- review-prepare
- review
- dast
- qa
- post-qa
- pages
- notify
default:
  image: registry.gitlab.com/gitlab-org/gitlab-build-images:ruby-2.7.2.patched-golang-1.14-git-2.31-lfs-2.9-chrome-89-node-14.15-yarn-1.22-postgresql-11-graphicsmagick-1.3.36
  tags:
  - gitlab-org
  interruptible: true
  timeout: 90m
workflow:
  rules:
  - if: "$FORCE_GITLAB_CI"
  - if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^release-tools\/\d+\.\d+\.\d+-rc\d+$/
      && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^[\d-]+-stable(-ee)?$/ && $CI_PROJECT_PATH
      == "gitlab-org/gitlab"
    when: never
  - if: "$CI_MERGE_REQUEST_IID"
  - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
  - if: "$CI_COMMIT_TAG"
  - if: "$GITLAB_INTERNAL == null"
    when: never
  - if: "$CI_COMMIT_BRANCH =~ /^[\\d-]+-stable(-ee)?$/"
  - if: "$CI_COMMIT_BRANCH =~ /^\\d+-\\d+-auto-deploy-\\d+$/"
  - if: "$CI_COMMIT_BRANCH =~ /^security\\//"
variables:
  RAILS_ENV: test
  NODE_ENV: test
  NODE_OPTIONS: "--max_old_space_size=3584"
  SIMPLECOV: 'true'
  GIT_DEPTH: '20'
  GIT_SUBMODULE_STRATEGY: none
  GET_SOURCES_ATTEMPTS: '3'
  KNAPSACK_RSPEC_SUITE_REPORT_PATH: knapsack/report-master.json
  FLAKY_RSPEC_SUITE_REPORT_PATH: rspec_flaky/report-suite.json
  RSPEC_TESTS_MAPPING_PATH: crystalball/mapping.json
  RSPEC_PACKED_TESTS_MAPPING_PATH: crystalball/packed-mapping.json
  BUILD_ASSETS_IMAGE: 'false'
  ES_JAVA_OPTS: "-Xms256m -Xmx256m"
  ELASTIC_URL: http://elastic:changeme@elasticsearch:9200
  DOCKER_VERSION: 20.10.1
  CACHE_CLASSES: 'true'
  CHECK_PRECOMPILED_ASSETS: 'true'
  FF_USE_FASTZIP: 'true'
  GIT_CLONE_PATH: "/builds/gitlab-org-forks/${CI_PROJECT_NAME}"
include:
- local: ".gitlab/ci/*.gitlab-ci.yml"
- template: Security/Secret-Detection.gitlab-ci.yml
