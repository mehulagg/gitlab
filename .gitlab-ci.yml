image: docker:1.11
services:
 - docker:1.11-dind

stages:
  - build
  - test

variables:
  QA_TEST_IMAGE_NAME: registry.gitlab.com/gitlab-org/gitlab-qa
  QA_TEST_IMAGE: $QA_TEST_IMAGE_NAME:$CI_BUILD_REF
  QA_TEST_IMAGE_LATEST: $QA_TEST_IMAGE_NAME:latest

build-image:
  stage: build
  script:
    - docker build -t $QA_TEST_IMAGE .
    - docker tag $QA_TEST_IMAGE $QA_TEST_IMAGE_LATEST
    - test -n "$CI_BUILD_TOKEN" || exit 0
    - docker login --username gitlab-ci-token --password $CI_BUILD_TOKEN registry.gitlab.com
    - docker push $QA_TEST_IMAGE
    - docker push $QA_TEST_IMAGE_LATEST
    - docker logout registry.gitlab.com
  except:
    - triggers

rubocop:
  image: ruby:2.2
  script:
    - gem install rubocop
    - rubocop
  except:
    - triggers

gitlab-ce-test:
  stage: test
  variables:
    HOSTNAME: gitlab-qa.test
    GITLAB_URL: http://$HOSTNAME
    MOUNT_VOLUMES_TO_SERVICES: "true"
  script:
    - docker network create test
    - docker run -d --net test --name gitlab-qa --hostname $HOSTNAME gitlab/gitlab-ce:latest
    - docker pull $QA_TEST_IMAGE
    - docker run -t --net test -e "GITLAB_URL=$GITLAB_URL" -v $(pwd):/tests $QA_TEST_IMAGE ./bin/run
