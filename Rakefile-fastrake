#!/usr/bin/env rake
# Add your own tasks in files placed in lib/tasks ending in .rake,
# for example lib/tasks/capistrano.rake, and they will automatically be available to Rake.

require File.expand_path('config/application-fastrake', __dir__)

namespace :geo do
  namespace :db do |ns|
    desc 'Succeeds (exit status 0) if foreign tables are out-of-date'
    task :foreign_tables_out_of_date do
      require 'pg'
      require Rails.root.join('ee/lib/gitlab/geo/geo_tasks')
      require Rails.root.join('ee/lib/gitlab/geo/fdw')
      require Rails.root.join('ee/lib/gitlab/geo/database_tasks')

      # This task should only be run on a Geo secondary. We do not check if Geo
      # node is a secondary because that requires all kinds of gems and files.

      unless Gitlab::Geo::GeoTasks.foreign_server_configured?
        puts "Error: Cannot check foreign tables, there is no foreign server configured."

        exit 1
      end

      if Gitlab::Geo::GeoTasks.foreign_tables_up_to_date?
        puts 'Foreign tables are up-to-date!'

        exit 1
      end

      puts 'Foreign tables are out-of-date! Please run the following task:'
      puts '  gitlab-rake geo:db:refresh_foreign_tables'
    end
  end
end
