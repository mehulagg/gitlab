# Read more about this feature here: https://docs.gitlab.com/ee/user/application_security/api_fuzzing/

# Configure the scanning tool through the environment variables.
# List of the variables: https://docs.gitlab.com/ee/user/application_security/api_fuzzing/#available-variables
# How to set: https://docs.gitlab.com/ee/ci/yaml/#variables

stages:
    - build
    - test
    - deploy
    - fuzz

variables:
    SECURE_ANALYZERS_PREFIX: "registry.gitlab.com/gitlab-org/security-products/analyzers"
    FUZZAPI_PROFILE: Quick
    FUZZAPI_VERSION: "1.6"
    FUZZAPI_CONFIG: .gitlab-api-fuzzing.yml
    FUZZAPI_TIMEOUT: 30
    FUZZAPI_REPORT: gl-api-fuzzing-report.json
    FUZZAPI_REPORT_ASSET_PATH: assets
    FUZZAPI_D_NETWORK: testing-net
    FUZZAPI_SERVICE_START_TIMEOUT: "300"
    FUZZAPI_IMAGE: ${SECURE_ANALYZERS_PREFIX}/api-fuzzing:${FUZZAPI_VERSION}-engine

apifuzzer_fuzz_unlicensed:
    stage: fuzz
    allow_failure: true
    rules:
        - if: '$GITLAB_FEATURES !~ /\bapi_fuzzing\b/ && $API_FUZZING_DISABLED == null'
        - when: never
    script:
        - |
            echo "Error: Your GitLab project is not licensed for API Fuzzing."
        - exit 1

apifuzzer_fuzz:
    stage: fuzz
    image: $FUZZAPI_IMAGE
    allow_failure: true
    rules:
        - if: $FUZZAPI_D_TARGET_IMAGE
          when: never
        - if: $FUZZAPI_D_WORKER_IMAGE
          when: never
        - if: $API_FUZZING_DISABLED
          when: never
        - if: $API_FUZZING_DISABLED_FOR_DEFAULT_BRANCH &&
                $CI_DEFAULT_BRANCH == $CI_COMMIT_REF_NAME
          when: never
        - if: $CI_COMMIT_BRANCH && $GITLAB_FEATURES =~ /\bapi_fuzzing\b/
    script:
        - /peach/analyzer-fuzz-api
    artifacts:
        when: always
        paths:
            - $FUZZAPI_REPORT_ASSET_PATH
            - $FUZZAPI_REPORT
            - $FUZZAPI_LOG_SCANNER
            - gl-*.log
        reports:
            api_fuzzing: $FUZZAPI_REPORT

apifuzzer_fuzz_dnd:
    stage: fuzz
    image: docker:19.03.12
    variables:
        DOCKER_DRIVER: overlay2
        DOCKER_TLS_CERTDIR: ""
    allow_failure: true
    rules:
        - if: $FUZZAPI_D_TARGET_IMAGE == null && $FUZZAPI_D_WORKER_IMAGE == null
          when: never
        - if: $API_FUZZING_DISABLED
          when: never
        - if: $API_FUZZING_DISABLED_FOR_DEFAULT_BRANCH &&
                $CI_DEFAULT_BRANCH == $CI_COMMIT_REF_NAME
          when: never
        - if: $CI_COMMIT_BRANCH && $GITLAB_FEATURES =~ /\bapi_fuzzing\b/
    services:
        - docker:19.03.12-dind
    script:
        - /peach/analyzer-fuzz-api
    after_script:
        #
        # Shutdown all containers
        - echo "Stopping all containers"
        - if [ "$FUZZAPI_D_TARGET_IMAGE" != "" ]; then docker stop target; fi
        - docker stop worker
        - docker stop apifuzzer
        #
        # Save docker logs
        - docker logs apifuzzer &> gl-api_fuzzing-logs.log
        - if [ "$FUZZAPI_D_TARGET_IMAGE" != "" ]; then docker logs target &> gl-api_fuzzing-target-logs.log; fi
        - docker logs worker &> gl-api_fuzzing-worker-logs.log
        #
    artifacts:
        when: always
        paths:
            - ./gl-*.log
            - ./gl-*.zip
            - $FUZZAPI_REPORT_ASSET_PATH
            - $FUZZAPI_REPORT
        reports:
            api_fuzzing: $FUZZAPI_REPORT

# end
