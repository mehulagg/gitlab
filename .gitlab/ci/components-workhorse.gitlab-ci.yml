.base_workhorse_job:
  extends:
    - .default-retry
    - .workhorse:rules
  image: golang:1.13
  stage: components
  before_script:
    - cd components/workhorse

workhorse verify:
  extends:
    - .base_workhorse_job
  script:
    - make verify

.workhorse_test_template:
  extends:
    - .base_workhorse_job
  services:
    - name: registry.gitlab.com/gitlab-org/build/cng/gitaly:latest
      # Disable the hooks so we don't have to stub the GitLab API
      command: ["/usr/bin/env", "GITALY_TESTING_NO_GIT_HOOKS=1", "/scripts/process-wrapper"]
      alias: gitaly
  variables:
    GITALY_ADDRESS: "tcp://gitaly:8075"
  script:
    - go version
    - apt-get update && apt-get -y install libimage-exiftool-perl
    - make test

workhorse test using go 1.13:
  extends:
    - .workhorse_test_template

workhorse test using go 1.14:
  extends:
    - .workhorse_test_template
  image: golang:1.14
