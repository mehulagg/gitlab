.compress-public: &compress-public
  - find public -type f -regex '.*\.\(htm\|html\|txt\|text\|js\|json\|css\|svg\|xml\)$' -exec gzip -f -k {} \;
  - find public -type f -regex '.*\.\(htm\|html\|txt\|text\|js\|json\|css\|svg\|xml\)$' -exec brotli -f -k {} \;

pages:
  extends:
    - .default-retry
    - .pages:rules
  stage: pages
  needs:
    - job: "rspec:coverage"
    - job: "coverage-frontend"
    - job: "karma"
    - job: "compile-production-assets"
    - job: "compile-storybook"
    # `update-tests-metadata` only runs on GitLab.com's EE schedules pipelines
    # while `pages` runs for all the 2-hourly schedules.
    - job: "update-tests-metadata"
      optional: true

  before_script:
    - apt-get update && apt-get -y install brotli gzip
  script:
    - mv public/ .public/
    - mkdir public/
    - mv coverage/ public/coverage-ruby/ || true
    - mv coverage-frontend/ public/coverage-frontend/ || true
    - mv coverage-javascript/ public/coverage-javascript/ || true
    - mv storybook/public public/storybook || true
    - cp .public/assets/application-*.css public/application.css || true
    - mv knapsack/ public/knapsack || true
    - mv rspec_flaky/ public/rspec_flaky || true
    - mv crystalball/packed-mapping.json.gz public/crystalball/packed-mapping.json.gz || true
    - *compress-public
  artifacts:
    paths:
      - public
    expire_in: 31d
